<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <title>Linkclump Background</title>
        <script type="text/javascript">
            chrome.extension.onRequest.addListener(function(request, sender, callback){
                if (request.message == 'openLink') {
                    if (request.new_window == true) {
                        chrome.windows.create()
                    }
                    
                    for (i = 0; i < request.urls.length; i++) {
                        chrome.tabs.create({
                            url: request.urls[i],
                            selected: false
                        });
                    }
                    
                    if (request.new_window == true) {
                        chrome.windows.getCurrent(function(window){
                            chrome.tabs.getAllInWindow(window.id, function(tabs){
                                chrome.tabs.remove(tabs[0].id)
                            })
                        })
                    }
                } else if (request.message == 'init') {
                    var mouse_button = null
                    var key_code = null
                    var os = 0
                    var smart_select = null
                    var new_window = null
                    var exclude_words = null
                    
                    if (navigator.appVersion.indexOf("Win") != -1) {
                        os = 1
                    }
                    
                    try {
                        exclude_words = window.localStorage.getItem('exclude_words')
                    } 
                    catch (exception) {
                    }
                    
                    try {
                        new_window = window.localStorage.getItem('new_window') == 'true'
                    } 
                    catch (exception) {
                    }
                    
                    try {
                        smart_select = window.localStorage.getItem('smart_select') == 'true'
                    } 
                    catch (exception) {
                    }
                    
                    try {
                        mouse_button = window.localStorage.getItem('mouse_button')
                        if (mouse_button != null) {
                            mouse_button = parseInt(mouse_button)
                        }
                    } 
                    catch (exception) {
                    }
                    
                    try {
                        key_code = window.localStorage.getItem('key_code')
                    } 
                    catch (exception) {
                    }
                    
                    if (exclude_words == null) {
                        exclude_words = ''
                        window.localStorage.setItem('exclude_words', exclude_words)
                    }
                    
                    if (new_window == null || new_window == '') {
                        new_window = false
                        window.localStorage.setItem('new_window', new_window)
                    }
                    
                    if (smart_select == null || smart_select == '') {
                        smart_select = true
                        window.localStorage.setItem('smart_select', smart_select)
                    }
                    
                    if (mouse_button == null || mouse_button == '') {
                        if (os == 1) {
                            mouse_button = 2
                        } else {
                            mouse_button = 0
                        }
                        window.localStorage.setItem('mouse_button', mouse_button)
                    }
                    
                    if (key_code == null) {
                        if (os == 1) {
                            key_code = ''
                        } else {
                            key_code = '16'
                        }
                        window.localStorage.setItem('key_code', key_code)
                    }
                    
                    callback({
                        mouse_button: mouse_button,
                        key_code: key_code,
                        os: os,
                        smart_select: smart_select,
                        new_window: new_window,
                        exclude_words: exclude_words
                    });
                }
            });
        </script>
    </head>
</html>
